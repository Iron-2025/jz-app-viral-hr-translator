<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Approved Ways to Tell Off Dumb People at Work</title>
    <link rel="icon" href="{{ url_for('static', filename='thumb_square_800x800.avif') }}" type="image/avif">
    <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background-color: #f9fafb;
  color: #111827;
  line-height: 1.6;
}

.container {
  max-width: 42rem;
  margin: 0 auto;
  padding: 0 1rem;
  padding-top: 3rem;
  padding-bottom: 3rem;
}

/* Header */
.header {
  text-align: center;
  margin-bottom: 4rem;
}

.title {
  font-size: 2.25rem;
  font-weight: 700;
  color: #111827;
  margin-bottom: 1rem;
}

.subtitle {
  font-size: 1.125rem;
  color: #6b7280;
  line-height: 1.75;
}

/* Posts */
.posts-container {
  display: flex;
  flex-direction: column;
  gap: 3rem;
}

.post {
  background: white;
  border-radius: 0.5rem;
  border: 1px solid #e5e7eb;
  padding: 2rem;
  transition: box-shadow 0.2s ease;
}

.post:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.real-thought {
  margin-bottom: 1.5rem;
}

.real-thought h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: #111827;
  line-height: 1.75;
  margin-bottom: 0.5rem;
}

/* Divider */
.divider {
  display: flex;
  align-items: center;
  margin-bottom: 1.5rem;
}

.divider-line {
  flex: 1;
  height: 1px;
  background-color: #e5e7eb;
}

.divider-text {
  padding: 0 1rem;
  color: #9ca3af;
  font-size: 0.875rem;
  font-weight: 500;
}

/* HR Version */
.hr-version {
  margin-bottom: 2rem;
}

.hr-version p {
  font-size: 1.125rem;
  color: #6b7280;
  line-height: 1.75;
  font-style: italic;
}

/* Actions */
.actions {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-top: 1rem;
  border-top: 1px solid #f3f4f6;
}

.action-buttons {
  display: flex;
  align-items: center;
  gap: 1.5rem;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: none;
  border: none;
  color: #6b7280;
  font-size: 0.875rem;
  cursor: pointer;
  transition: color 0.2s ease;
  padding: 0.25rem;
}

.action-btn:hover {
  color: #374151;
}

.action-btn.liked {
  color: #ef4444;
}

.action-btn.liked .heart-icon {
  fill: currentColor;
}

.post-number {
  font-size: 0.75rem;
  color: #9ca3af;
}

/* Icons */
.icon {
  width: 1.25rem;
  height: 1.25rem;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.heart-icon {
  transition: fill 0.2s ease;
}

/* Loading */
.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 3rem 0;
  gap: 0.75rem;
  color: #6b7280;
}

.spinner {
  width: 1.5rem;
  height: 1.5rem;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #9ca3af;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* End Message */
.end-message {
  text-align: center;
  padding: 3rem 0;
  color: #6b7280;
}

/* Utility */
.hidden {
  display: none !important;
}

/* Responsive */
@media (max-width: 640px) {
  .container {
    padding: 0 1rem;
    padding-top: 2rem;
    padding-bottom: 2rem;
  }

  .header {
    margin-bottom: 3rem;
  }

  .title {
    font-size: 2rem;
  }

  .subtitle {
    font-size: 1rem;
  }

  .post {
    padding: 1.5rem;
  }

  .real-thought h2 {
    font-size: 1.25rem;
  }

  .hr-version p {
    font-size: 1rem;
  }

  .action-buttons {
    gap: 1rem;
  }
}

/* Share Modal */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background-color: #fff;
  padding: 2rem;
  border-radius: 0.5rem;
  border: 1px solid #e5e7eb;
  width: 90%;
  max-width: 500px;
  position: relative;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.close-button {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  position: absolute;
  top: 10px;
  right: 20px;
  cursor: pointer;
}

.close-button:hover,
.close-button:focus {
  color: black;
  text-decoration: none;
}

.modal-content h3 {
  margin-bottom: 1rem;
}

.modal-content p {
  margin-bottom: 1.5rem;
  font-style: italic;
  color: #6b7280;
}

.share-links {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.share-links a {
  display: inline-block;
  padding: 0.75rem 1.5rem;
  border-radius: 0.375rem;
  text-decoration: none;
  font-weight: 500;
  transition: background-color 0.2s ease;
  color: white;
}

#share-twitter { background-color: #1DA1F2; }
#share-twitter:hover { background-color: #0c85d0; }
#share-facebook { background-color: #1877F2; }
#share-facebook:hover { background-color: #166fe5; }
#share-reddit { background-color: #FF4500; }
#share-reddit:hover { background-color: #cc3700; }

.copy-link-container {
  display: flex;
}

.copy-link-container input {
  flex-grow: 1;
  padding: 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 0.25rem 0 0 0.25rem;
  background-color: #f9fafb;
}

.copy-link-container button {
  padding: 0.5rem 1rem;
  border: 1px solid #3b82f6;
  background-color: #3b82f6;
  color: white;
  border-radius: 0 0.25rem 0.25rem 0;
  cursor: pointer;
}

.copy-link-container button:hover {
  background-color: #2563eb;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="title">HR Approved Ways to Tell Off Dumb People at Work</h1>
        </header>

        <!-- Posts Container -->
        <div id="posts-container" class="posts-container">
            <!-- Posts will be dynamically inserted here -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <span>Loading more...</span>
        </div>

        <!-- End Message -->
        <div id="end-message" class="end-message hidden">
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Share this thought</h3>
            <p id="share-text"></p>
            <div class="share-links">
                <a id="share-twitter" href="#" target="_blank">X (Twitter)</a>
                <a id="share-facebook" href="#" target="_blank">Facebook</a>
                <a id="share-reddit" href="#" target="_blank">Reddit</a>
            </div>
            <div class="copy-link-container">
                <input type="text" id="share-url" readonly>
                <button id="copy-link-btn">Copy Link</button>
            </div>
        </div>
    </div>

    <script>
class HRTranslator {
  constructor() {
    this.displayedPairs = []
    this.loading = false
    this.hasMore = true
    this.currentPage = 1 // Start with page 1
    this.likedPairs = new Set()
    // this.postsPerLoad is now determined by the backend (JOKES_PER_PAGE)

    this.postsContainer = document.getElementById("posts-container")
    this.loadingElement = document.getElementById("loading")
    this.endMessageElement = document.getElementById("end-message")

    // Share Modal Elements
    this.shareModal = document.getElementById("share-modal");
    this.closeModalBtn = this.shareModal.querySelector(".close-button");
    this.shareTextElement = this.shareModal.querySelector("#share-text");
    this.shareUrlInput = this.shareModal.querySelector("#share-url");
    this.copyLinkBtn = this.shareModal.querySelector("#copy-link-btn");
    this.twitterShareLink = this.shareModal.querySelector("#share-twitter");
    this.facebookShareLink = this.shareModal.querySelector("#share-facebook");
    this.redditShareLink = this.shareModal.querySelector("#share-reddit");

    this.init()
  }

  init() {
    this.loadLikedPairsFromStorage();
    this.loadMorePairs();
    this.setupScrollListener();
    this.setupShareModalListeners();
  }

  loadMorePairs() {
    if (this.loading || !this.hasMore) return

    this.loading = true
    this.showLoading()

    fetch(`/get_jokes_page/${this.currentPage}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(nextPairs => {
        if (nextPairs.length === 0) {
          this.hasMore = false;
          this.showEndMessage();
        } else {
          nextPairs.forEach((pair) => {
            // Ensure displayedPairs doesn't grow indefinitely if not needed for other logic
            // For now, keeping original behavior of appending
            this.displayedPairs.push(pair); 
            this.renderPost(pair);
          });
          this.currentPage++; // Increment page number for the next fetch
        }
      })
      .catch(error => {
        console.error("Failed to load more pairs:", error);
        // Optionally, show an error message to the user
        this.hasMore = false; // Stop trying to load more if an error occurs
        this.showEndMessage(); // Or a specific error message element
      })
      .finally(() => {
        this.loading = false;
        this.hideLoading();
      });
  }

  renderPost(pair) {
    const postElement = document.createElement("article")
    postElement.className = "post"
    postElement.innerHTML = `
            <div class="real-thought">
                <h2>"${pair.realThought}"</h2>
            </div>
            
            <div class="divider">
                <div class="divider-line"></div>
                <div class="divider-text">HR APPROVED</div>
                <div class="divider-line"></div>
            </div>
            
            <div class="hr-version">
                <p>"${pair.hrVersion}"</p>
            </div>
            
            <div class="actions">
                <div class="action-buttons">
                    <button class="action-btn like-btn" data-id="${pair.id}">
                        <svg class="icon heart-icon" viewBox="0 0 24 24">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span class="like-count">${pair.like_count || 0}</span>
                    </button>
                    
                    <button class="action-btn share-btn">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13"></path>
                        </svg>
                        <span>Share</span>
                    </button>
                </div>
                
                <div class="post-number">#${pair.id}</div>
            </div>
        `

    // Add like functionality
    const likeBtn = postElement.querySelector(".like-btn");
    if (this.likedPairs.has(pair.id)) {
        likeBtn.classList.add("liked");
    }
    likeBtn.addEventListener("click", () => this.toggleLike(pair.id, likeBtn));

    // Add share functionality
    const shareBtn = postElement.querySelector(".share-btn");
    shareBtn.addEventListener("click", () => this.handleShare(pair));

    this.postsContainer.appendChild(postElement)
  }

  toggleLike(pairId, buttonElement) {
    const likeCountElement = buttonElement.querySelector(".like-count");
    let currentCount = Number.parseInt(likeCountElement.textContent);

    if (this.likedPairs.has(pairId)) {
      // User is unliking the post
      this.likedPairs.delete(pairId);
      localStorage.removeItem(`liked_post_${pairId}`);
      buttonElement.classList.remove("liked");
      // For simplicity, we don't send an "unlike" request to the server.
      // The count will be corrected on next page load if it was already liked.
      // We can decrement visually for immediate feedback.
      likeCountElement.textContent = currentCount > 0 ? currentCount - 1 : 0;

    } else {
      // User is liking the post
      this.likedPairs.add(pairId);
      localStorage.setItem(`liked_post_${pairId}`, 'true');
      buttonElement.classList.add("liked");
      
      // Visually increment immediately
      likeCountElement.textContent = currentCount + 1;

      // Send like to the server
      fetch(`/like/${pairId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          // Update the count with the authoritative value from the server
          if (data && typeof data.like_count !== 'undefined') {
            likeCountElement.textContent = data.like_count;
          }
        })
        .catch(error => {
          console.error('Error liking post:', error);
          // Revert visual change if server update fails
          likeCountElement.textContent = currentCount; 
          this.likedPairs.delete(pairId);
          localStorage.removeItem(`liked_post_${pairId}`);
          buttonElement.classList.remove("liked");
        });
    }
  }

  setupScrollListener() {
    window.addEventListener("scroll", () => {
      if (window.innerHeight + document.documentElement.scrollTop >= document.documentElement.offsetHeight - 1000) {
        this.loadMorePairs()
      }
    })
  }

  showLoading() {
    this.loadingElement.classList.remove("hidden")
  }

  hideLoading() {
    this.loadingElement.classList.add("hidden")
  }

  showEndMessage() {
    this.endMessageElement.classList.remove("hidden")
  }

  getRandomNumber(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min
  }

  // --- Share Functionality ---

  setupShareModalListeners() {
    this.closeModalBtn.addEventListener("click", () => this.hideShareModal());
    window.addEventListener("click", (event) => {
      if (event.target == this.shareModal) {
        this.hideShareModal();
      }
    });
    this.copyLinkBtn.addEventListener("click", () => {
      this.shareUrlInput.select();
      navigator.clipboard.writeText(this.shareUrlInput.value).then(() => {
        this.copyLinkBtn.textContent = "Copied!";
        setTimeout(() => { this.copyLinkBtn.textContent = "Copy Link"; }, 2000);
      });
    });
  }

  showShareModal() {
    this.shareModal.classList.remove("hidden");
  }

  hideShareModal() {
    this.shareModal.classList.add("hidden");
  }

  handleShare(pair) {
    const text = `Real Thought: "${pair.realThought}"\nHR Version: "${pair.hrVersion}"`;
    const url = window.location.href;
    
    this.shareTextElement.textContent = text;
    this.shareUrlInput.value = url;

    const encodedUrl = encodeURIComponent(url);
    const encodedText = encodeURIComponent(text);

    this.twitterShareLink.href = `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedText}`;
    this.facebookShareLink.href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}`;
    this.redditShareLink.href = `https://www.reddit.com/submit?url=${encodedUrl}&title=${encodedText}`;
    
    this.showShareModal();
  }

  loadLikedPairsFromStorage() {
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith('liked_post_')) {
        const pairId = parseInt(key.replace('liked_post_', ''), 10);
        if (!isNaN(pairId)) {
          this.likedPairs.add(pairId);
        }
      }
    }
  }
}

// Initialize the app when the DOM is loaded
document.addEventListener("DOMContentLoaded", () => {
  new HRTranslator()
})
    </script>
</body>
</html>
